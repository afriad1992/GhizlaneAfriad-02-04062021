(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[91],{odOL:function(e,t,n){(function(e){(function(t){"use strict";var r="undefined"!==typeof e?e:"undefined"!==typeof self?self:"undefined"!==typeof window?window:{};function s(e){return(s="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}function c(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(e,t){return!t||"object"!==typeof t&&"function"!==typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function d(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=u(e);if(t){var s=u(this).constructor;n=Reflect.construct(r,arguments,s)}else n=r.apply(this,arguments);return l(this,n)}}function _(e){return function(e){if(Array.isArray(e))return f(e)}(e)||function(e){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(e){if("string"===typeof e)return f(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?f(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var m=function(){var e=r.WebSocket;if("undefined"===typeof e)try{e=n("f3NI")}catch(t){throw new Error('You must install the "ws" package to use Strophe in nodejs.')}return e}(),p=function(){var e=r.DOMParser;if("undefined"===typeof e)try{e=n("KdhP").DOMParser}catch(t){throw new Error('You must install the "xmldom" package to use Strophe in nodejs.')}return e}();function g(){if("undefined"===typeof document)try{return(new(0,n("KdhP").DOMImplementation)).createDocument("jabber:client","strophe",null)}catch(t){throw new Error('You must install the "xmldom" package to use Strophe in nodejs.')}if(void 0===document.implementation.createDocument||document.implementation.createDocument&&document.documentMode&&document.documentMode<10){var e=function(){for(var e=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],t=0;t<e.length;t++)try{return new ActiveXObject(e[t])}catch(n){}}();return e.appendChild(e.createElement("strophe")),e}return document.implementation.createDocument("jabber:client","strophe",null)}var v=function(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n},y=function(e){if("string"!==typeof e)throw new Error("str2binl was passed a non-string");for(var t=[],n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t},S=function(e,t,n,r,s,i){return v((o=v(v(t,e),v(r,i)))<<(a=s)|o>>>32-a,n);var o,a},b=function(e,t,n,r,s,i,o){return S(t&n|~t&r,e,t,s,i,o)},T=function(e,t,n,r,s,i,o){return S(t&r|n&~r,e,t,s,i,o)},N=function(e,t,n,r,s,i,o){return S(t^n^r,e,t,s,i,o)},x=function(e,t,n,r,s,i,o){return S(n^(t|~r),e,t,s,i,o)},A=function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n,r,s,i,o=1732584193,a=-271733879,c=-1732584194,u=271733878,h=0;h<e.length;h+=16)n=o,r=a,s=c,i=u,o=b(o,a,c,u,e[h+0],7,-680876936),u=b(u,o,a,c,e[h+1],12,-389564586),c=b(c,u,o,a,e[h+2],17,606105819),a=b(a,c,u,o,e[h+3],22,-1044525330),o=b(o,a,c,u,e[h+4],7,-176418897),u=b(u,o,a,c,e[h+5],12,1200080426),c=b(c,u,o,a,e[h+6],17,-1473231341),a=b(a,c,u,o,e[h+7],22,-45705983),o=b(o,a,c,u,e[h+8],7,1770035416),u=b(u,o,a,c,e[h+9],12,-1958414417),c=b(c,u,o,a,e[h+10],17,-42063),a=b(a,c,u,o,e[h+11],22,-1990404162),o=b(o,a,c,u,e[h+12],7,1804603682),u=b(u,o,a,c,e[h+13],12,-40341101),c=b(c,u,o,a,e[h+14],17,-1502002290),a=b(a,c,u,o,e[h+15],22,1236535329),o=T(o,a,c,u,e[h+1],5,-165796510),u=T(u,o,a,c,e[h+6],9,-1069501632),c=T(c,u,o,a,e[h+11],14,643717713),a=T(a,c,u,o,e[h+0],20,-373897302),o=T(o,a,c,u,e[h+5],5,-701558691),u=T(u,o,a,c,e[h+10],9,38016083),c=T(c,u,o,a,e[h+15],14,-660478335),a=T(a,c,u,o,e[h+4],20,-405537848),o=T(o,a,c,u,e[h+9],5,568446438),u=T(u,o,a,c,e[h+14],9,-1019803690),c=T(c,u,o,a,e[h+3],14,-187363961),a=T(a,c,u,o,e[h+8],20,1163531501),o=T(o,a,c,u,e[h+13],5,-1444681467),u=T(u,o,a,c,e[h+2],9,-51403784),c=T(c,u,o,a,e[h+7],14,1735328473),a=T(a,c,u,o,e[h+12],20,-1926607734),o=N(o,a,c,u,e[h+5],4,-378558),u=N(u,o,a,c,e[h+8],11,-2022574463),c=N(c,u,o,a,e[h+11],16,1839030562),a=N(a,c,u,o,e[h+14],23,-35309556),o=N(o,a,c,u,e[h+1],4,-1530992060),u=N(u,o,a,c,e[h+4],11,1272893353),c=N(c,u,o,a,e[h+7],16,-155497632),a=N(a,c,u,o,e[h+10],23,-1094730640),o=N(o,a,c,u,e[h+13],4,681279174),u=N(u,o,a,c,e[h+0],11,-358537222),c=N(c,u,o,a,e[h+3],16,-722521979),a=N(a,c,u,o,e[h+6],23,76029189),o=N(o,a,c,u,e[h+9],4,-640364487),u=N(u,o,a,c,e[h+12],11,-421815835),c=N(c,u,o,a,e[h+15],16,530742520),a=N(a,c,u,o,e[h+2],23,-995338651),o=x(o,a,c,u,e[h+0],6,-198630844),u=x(u,o,a,c,e[h+7],10,1126891415),c=x(c,u,o,a,e[h+14],15,-1416354905),a=x(a,c,u,o,e[h+5],21,-57434055),o=x(o,a,c,u,e[h+12],6,1700485571),u=x(u,o,a,c,e[h+3],10,-1894986606),c=x(c,u,o,a,e[h+10],15,-1051523),a=x(a,c,u,o,e[h+1],21,-2054922799),o=x(o,a,c,u,e[h+8],6,1873313359),u=x(u,o,a,c,e[h+15],10,-30611744),c=x(c,u,o,a,e[h+6],15,-1560198380),a=x(a,c,u,o,e[h+13],21,1309151649),o=x(o,a,c,u,e[h+4],6,-145523070),u=x(u,o,a,c,e[h+11],10,-1120210379),c=x(c,u,o,a,e[h+2],15,718787259),a=x(a,c,u,o,e[h+9],21,-343485551),o=v(o,n),a=v(a,r),c=v(c,s),u=v(u,i);return[o,a,c,u]},w={hexdigest:function(e){return function(e){for(var t="0123456789abcdef",n="",r=0;r<4*e.length;r++)n+=t.charAt(e[r>>2]>>r%4*8+4&15)+t.charAt(e[r>>2]>>r%4*8&15);return n}(A(y(e),8*e.length))},hash:function(e){return function(e){for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>n%32&255);return t}(A(y(e),8*e.length))}};function C(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;var n,r,s,i,o,a,c,u,h=new Array(80),l=1732584193,d=-271733879,_=-1732584194,f=271733878,m=-1009589776;for(n=0;n<e.length;n+=16){for(i=l,o=d,a=_,c=f,u=m,r=0;r<80;r++)h[r]=r<16?e[n+r]:R(h[r-3]^h[r-8]^h[r-14]^h[r-16],1),s=I(I(R(l,5),k(r,d,_,f)),I(I(m,h[r]),E(r))),m=f,f=_,_=R(d,30),d=l,l=s;l=I(l,i),d=I(d,o),_=I(_,a),f=I(f,c),m=I(m,u)}return[l,d,_,f,m]}function k(e,t,n,r){return e<20?t&n|~t&r:e<40?t^n^r:e<60?t&n|t&r|n&r:t^n^r}function E(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function O(e,t){var n=H(e);n.length>16&&(n=C(n,8*e.length));for(var r=new Array(16),s=new Array(16),i=0;i<16;i++)r[i]=909522486^n[i],s[i]=1549556828^n[i];var o=C(r.concat(H(t)),512+8*t.length);return C(s.concat(o),672)}function I(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function R(e,t){return e<<t|e>>>32-t}function H(e){for(var t=[],n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<24-n%32;return t}function M(e){for(var t,n,r="",s=0;s<4*e.length;s+=3)for(t=(e[s>>2]>>8*(3-s%4)&255)<<16|(e[s+1>>2]>>8*(3-(s+1)%4)&255)<<8|e[s+2>>2]>>8*(3-(s+2)%4)&255,n=0;n<4;n++)8*s+6*n>32*e.length?r+="=":r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(t>>6*(3-n)&63);return r}function L(e){for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>24-n%32&255);return t}var D={b64_hmac_sha1:function(e,t){return M(O(e,t))},b64_sha1:function(e){return M(C(H(e),8*e.length))},binb2str:L,core_hmac_sha1:O,str_hmac_sha1:function(e,t){return L(O(e,t))},str_sha1:function(e){return L(C(H(e),8*e.length))}},q=function(e){var t,n,r="",s=e.length;for(t=0;t<s;t++)(n=e.charCodeAt(t))>=0&&n<=127?r+=e.charAt(t):n>2047?(r+=String.fromCharCode(224|n>>12&15),r+=String.fromCharCode(128|n>>6&63),r+=String.fromCharCode(128|n>>0&63)):(r+=String.fromCharCode(192|n>>6&31),r+=String.fromCharCode(128|n>>0&63));return r},F=function(e){for(var t in e=e||{})if(Object.prototype.hasOwnProperty.call(e,t)){var n="",r="",i="",o=e[t],a="object"===s(o),c=escape(unescape(a?o.value:o));a&&(n=o.expires?";expires="+o.expires:"",r=o.domain?";domain="+o.domain:"",i=o.path?";path="+o.path:""),document.cookie=t+"="+c+n+r+i}};var B={atob:function(e){if((e=(e="".concat(e)).replace(/[ \t\n\f\r]/g,"")).length%4===0&&(e=e.replace(/==?$/,"")),e.length%4===1||/[^+/0-9A-Za-z]/.test(e))return null;for(var t="",n=0,r=0,s=0;s<e.length;s++)n<<=6,n|=(i=e[s],/[A-Z]/.test(i)?i.charCodeAt(0)-"A".charCodeAt(0):/[a-z]/.test(i)?i.charCodeAt(0)-"a".charCodeAt(0)+26:/[0-9]/.test(i)?i.charCodeAt(0)-"0".charCodeAt(0)+52:"+"===i?62:"/"===i?63:void 0),24===(r+=6)&&(t+=String.fromCharCode((16711680&n)>>16),t+=String.fromCharCode((65280&n)>>8),t+=String.fromCharCode(255&n),n=r=0);var i;return 12===r?(n>>=4,t+=String.fromCharCode(n)):18===r&&(n>>=2,t+=String.fromCharCode((65280&n)>>8),t+=String.fromCharCode(255&n)),t},btoa:function(e){var t;for(e="".concat(e),t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return null;var n,r="";for(t=0;t<e.length;t+=3){var s=[void 0,void 0,void 0,void 0];s[0]=e.charCodeAt(t)>>2,s[1]=(3&e.charCodeAt(t))<<4,e.length>t+1&&(s[1]|=e.charCodeAt(t+1)>>4,s[2]=(15&e.charCodeAt(t+1))<<2),e.length>t+2&&(s[2]|=e.charCodeAt(t+2)>>6,s[3]=63&e.charCodeAt(t+2));for(var i=0;i<s.length;i++)"undefined"===typeof s[i]?r+="=":r+=(n=s[i])<26?String.fromCharCode(n+"A".charCodeAt(0)):n<52?String.fromCharCode(n-26+"a".charCodeAt(0)):n<62?String.fromCharCode(n-52+"0".charCodeAt(0)):62===n?"+":63===n?"/":void 0}return r}};function j(e,t){return new U.Builder(e,t)}function P(e){return new U.Builder("message",e)}function X(e){return new U.Builder("iq",e)}function J(e){return new U.Builder("presence",e)}var U={VERSION:"1.4.1",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(e){for(var t=0;t<U.XHTML.tags.length;t++)if(e===U.XHTML.tags[t])return!0;return!1},validAttribute:function(e,t){if("undefined"!==typeof U.XHTML.attributes[e]&&U.XHTML.attributes[e].length>0)for(var n=0;n<U.XHTML.attributes[e].length;n++)if(t===U.XHTML.attributes[e][n])return!0;return!1},validCSS:function(e){for(var t=0;t<U.XHTML.css.length;t++)if(e===U.XHTML.css[t])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10,BINDREQUIRED:11,ATTACHFAIL:12},ErrorCondition:{BAD_FORMAT:"bad-format",CONFLICT:"conflict",MISSING_JID_NODE:"x-strophe-bad-non-anon-jid",NO_AUTH_MECH:"no-auth-mech",UNKNOWN_REASON:"unknown"},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace:function(e,t){U.NS[e]=t},forEachChild:function(e,t,n){for(var r=0;r<e.childNodes.length;r++){var s=e.childNodes[r];s.nodeType!==U.ElementType.NORMAL||t&&!this.isTagEqual(s,t)||n(s)}},isTagEqual:function(e,t){return e.tagName===t},_xmlGenerator:null,xmlGenerator:function(){return U._xmlGenerator||(U._xmlGenerator=g()),U._xmlGenerator},xmlElement:function(e){if(!e)return null;for(var t=U.xmlGenerator().createElement(e),n=1;n<arguments.length;n++){var r=arguments[n];if(r)if("string"===typeof r||"number"===typeof r)t.appendChild(U.xmlTextNode(r));else if("object"===s(r)&&"function"===typeof r.sort)for(var i=0;i<r.length;i++){var o=r[i];"object"===s(o)&&"function"===typeof o.sort&&void 0!==o[1]&&null!==o[1]&&t.setAttribute(o[0],o[1])}else if("object"===s(r))for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&void 0!==r[a]&&null!==r[a]&&t.setAttribute(a,r[a])}return t},xmlescape:function(e){return e=(e=(e=(e=(e=e.replace(/\&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/'/g,"&apos;")).replace(/"/g,"&quot;")},xmlunescape:function(e){return e=(e=(e=(e=(e=e.replace(/\&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&apos;/g,"'")).replace(/&quot;/g,'"')},xmlTextNode:function(e){return U.xmlGenerator().createTextNode(e)},xmlHtmlNode:function(e){var t;return p?t=(new p).parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e)),t},getText:function(e){if(!e)return null;var t="";0===e.childNodes.length&&e.nodeType===U.ElementType.TEXT&&(t+=e.nodeValue);for(var n=0;n<e.childNodes.length;n++)e.childNodes[n].nodeType===U.ElementType.TEXT&&(t+=e.childNodes[n].nodeValue);return U.xmlescape(t)},copyElement:function(e){var t;if(e.nodeType===U.ElementType.NORMAL){t=U.xmlElement(e.tagName);for(var n=0;n<e.attributes.length;n++)t.setAttribute(e.attributes[n].nodeName,e.attributes[n].value);for(var r=0;r<e.childNodes.length;r++)t.appendChild(U.copyElement(e.childNodes[r]))}else e.nodeType===U.ElementType.TEXT&&(t=U.xmlGenerator().createTextNode(e.nodeValue));return t},createHtml:function(e){var t;if(e.nodeType===U.ElementType.NORMAL){var n=e.nodeName.toLowerCase();if(U.XHTML.validTag(n))try{t=U.xmlElement(n);for(var r=0;r<U.XHTML.attributes[n].length;r++){var i=U.XHTML.attributes[n][r],o=e.getAttribute(i);if("undefined"!==typeof o&&null!==o&&""!==o&&!1!==o&&0!==o)if("style"===i&&"object"===s(o)&&"undefined"!==typeof o.cssText&&(o=o.cssText),"style"===i){for(var a=[],c=o.split(";"),u=0;u<c.length;u++){var h=c[u].split(":"),l=h[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase();if(U.XHTML.validCSS(l)){var d=h[1].replace(/^\s*/,"").replace(/\s*$/,"");a.push(l+": "+d)}}a.length>0&&(o=a.join("; "),t.setAttribute(i,o))}else t.setAttribute(i,o)}for(var _=0;_<e.childNodes.length;_++)t.appendChild(U.createHtml(e.childNodes[_]))}catch(p){t=U.xmlTextNode("")}else{t=U.xmlGenerator().createDocumentFragment();for(var f=0;f<e.childNodes.length;f++)t.appendChild(U.createHtml(e.childNodes[f]))}}else if(e.nodeType===U.ElementType.FRAGMENT){t=U.xmlGenerator().createDocumentFragment();for(var m=0;m<e.childNodes.length;m++)t.appendChild(U.createHtml(e.childNodes[m]))}else e.nodeType===U.ElementType.TEXT&&(t=U.xmlTextNode(e.nodeValue));return t},escapeNode:function(e){return"string"!==typeof e?e:e.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(e){return"string"!==typeof e?e:e.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(e){return e.indexOf("@")<0?null:e.split("@")[0]},getDomainFromJid:function(e){var t=U.getBareJidFromJid(e);if(t.indexOf("@")<0)return t;var n=t.split("@");return n.splice(0,1),n.join("@")},getResourceFromJid:function(e){if(!e)return null;var t=e.split("/");return t.length<2?null:(t.splice(0,1),t.join("/"))},getBareJidFromJid:function(e){return e?e.split("/")[0]:null},_handleError:function(e){"undefined"!==typeof e.stack&&U.fatal(e.stack),e.sourceURL?U.fatal("error: "+this.handler+" "+e.sourceURL+":"+e.line+" - "+e.name+": "+e.message):e.fileName?U.fatal("error: "+this.handler+" "+e.fileName+":"+e.lineNumber+" - "+e.name+": "+e.message):U.fatal("error: "+e.message)},log:function(e,t){var n;e===this.LogLevel.FATAL&&(null===(n=console)||void 0===n||n.error(t))},debug:function(e){this.log(this.LogLevel.DEBUG,e)},info:function(e){this.log(this.LogLevel.INFO,e)},warn:function(e){this.log(this.LogLevel.WARN,e)},error:function(e){this.log(this.LogLevel.ERROR,e)},fatal:function(e){this.log(this.LogLevel.FATAL,e)},serialize:function(e){if(!e)return null;"function"===typeof e.tree&&(e=e.tree());var t=_(Array(e.attributes.length).keys()).map((function(t){return e.attributes[t].nodeName}));t.sort();var n=t.reduce((function(t,n){return"".concat(t," ").concat(n,'="').concat(U.xmlescape(e.attributes.getNamedItem(n).value),'"')}),"<".concat(e.nodeName));if(e.childNodes.length>0){n+=">";for(var r=0;r<e.childNodes.length;r++){var s=e.childNodes[r];switch(s.nodeType){case U.ElementType.NORMAL:n+=U.serialize(s);break;case U.ElementType.TEXT:n+=U.xmlescape(s.nodeValue);break;case U.ElementType.CDATA:n+="<![CDATA["+s.nodeValue+"]]>"}}n+="</"+e.nodeName+">"}else n+="/>";return n},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(e,t){U._connectionPlugins[e]=t}};U.Builder=function(){function e(t,n){i(this,e),"presence"!==t&&"message"!==t&&"iq"!==t||(n&&!n.xmlns?n.xmlns=U.NS.CLIENT:n||(n={xmlns:U.NS.CLIENT})),this.nodeTree=U.xmlElement(t,n),this.node=this.nodeTree}return a(e,[{key:"tree",value:function(){return this.nodeTree}},{key:"toString",value:function(){return U.serialize(this.nodeTree)}},{key:"up",value:function(){return this.node=this.node.parentNode,this}},{key:"root",value:function(){return this.node=this.nodeTree,this}},{key:"attrs",value:function(e){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(void 0===e[t]?this.node.removeAttribute(t):this.node.setAttribute(t,e[t]));return this}},{key:"c",value:function(e,t,n){var r=U.xmlElement(e,t,n);return this.node.appendChild(r),"string"!==typeof n&&"number"!==typeof n&&(this.node=r),this}},{key:"cnode",value:function(e){var t,n=U.xmlGenerator();try{t=void 0!==n.importNode}catch(s){t=!1}var r=t?n.importNode(e,!0):U.copyElement(e);return this.node.appendChild(r),this.node=r,this}},{key:"t",value:function(e){var t=U.xmlTextNode(e);return this.node.appendChild(t),this}},{key:"h",value:function(e){var t=U.xmlGenerator().createElement("body");t.innerHTML=e;for(var n=U.createHtml(t);n.childNodes.length>0;)this.node.appendChild(n.childNodes[0]);return this}}]),e}(),U.Handler=function(e,t,n,r,s,i,o){this.handler=e,this.ns=t,this.name=n,this.type=r,this.id=s,this.options=o||{matchBareFromJid:!1,ignoreNamespaceFragment:!1},this.options.matchBare&&(U.warn('The "matchBare" option is deprecated, use "matchBareFromJid" instead.'),this.options.matchBareFromJid=this.options.matchBare,delete this.options.matchBare),this.options.matchBareFromJid?this.from=i?U.getBareJidFromJid(i):null:this.from=i,this.user=!0},U.Handler.prototype={getNamespace:function(e){var t=e.getAttribute("xmlns");return t&&this.options.ignoreNamespaceFragment&&(t=t.split("#")[0]),t},namespaceMatch:function(e){var t=this,n=!1;return!this.ns||(U.forEachChild(e,null,(function(e){t.getNamespace(e)===t.ns&&(n=!0)})),n||this.getNamespace(e)===this.ns)},isMatch:function(e){var t=e.getAttribute("from");this.options.matchBareFromJid&&(t=U.getBareJidFromJid(t));var n=e.getAttribute("type");return!(!this.namespaceMatch(e)||this.name&&!U.isTagEqual(e,this.name)||this.type&&(Array.isArray(this.type)?-1===this.type.indexOf(n):n!==this.type)||this.id&&e.getAttribute("id")!==this.id||this.from&&t!==this.from)},run:function(e){var t=null;try{t=this.handler(e)}catch(n){throw U._handleError(n),n}return t},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}},U.TimedHandler=function(){function e(t,n){i(this,e),this.period=t,this.handler=n,this.lastCalled=(new Date).getTime(),this.user=!0}return a(e,[{key:"run",value:function(){return this.lastCalled=(new Date).getTime(),this.handler()}},{key:"reset",value:function(){this.lastCalled=(new Date).getTime()}},{key:"toString",value:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}}]),e}(),U.Connection=function(){function e(t,n){var r=this;for(var s in i(this,e),this.service=t,this.options=n||{},this.setProtocol(),this.jid="",this.domain=null,this.features=null,this._sasl_data={},this.do_bind=!1,this.do_session=!1,this.mechanisms={},this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.protocolErrorHandlers={HTTP:{},websocket:{}},this._idleTimeout=null,this._disconnectTimeout=null,this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.do_authentication=!0,this.paused=!1,this.restored=!1,this._data=[],this._uniqueId=0,this._sasl_success_handler=null,this._sasl_failure_handler=null,this._sasl_challenge_handler=null,this.maxRetries=5,this._idleTimeout=setTimeout((function(){return r._onIdle()}),100),F(this.options.cookies),this.registerSASLMechanisms(this.options.mechanisms),U._connectionPlugins)if(Object.prototype.hasOwnProperty.call(U._connectionPlugins,s)){var o=function(){};o.prototype=U._connectionPlugins[s],this[s]=new o,this[s].init(this)}}return a(e,[{key:"setProtocol",value:function(){var e=this.options.protocol||"";this.options.worker?this._proto=new U.WorkerWebsocket(this):0===this.service.indexOf("ws:")||0===this.service.indexOf("wss:")||0===e.indexOf("ws")?this._proto=new U.Websocket(this):this._proto=new U.Bosh(this)}},{key:"reset",value:function(){this._proto._reset(),this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.restored=!1,this._data=[],this._requests=[],this._uniqueId=0}},{key:"pause",value:function(){this.paused=!0}},{key:"resume",value:function(){this.paused=!1}},{key:"getUniqueId",value:function(e){var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}));return"string"===typeof e||"number"===typeof e?t+":"+e:t+""}},{key:"addProtocolErrorHandler",value:function(e,t,n){this.protocolErrorHandlers[e][t]=n}},{key:"connect",value:function(e,t,n,r,s,i,o){this.jid=e,this.authzid=U.getBareJidFromJid(this.jid),this.authcid=o||U.getNodeFromJid(this.jid),this.pass=t,this.connect_callback=n,this.disconnecting=!1,this.connected=!1,this.authenticated=!1,this.restored=!1,this.domain=U.getDomainFromJid(this.jid),this._changeConnectStatus(U.Status.CONNECTING,null),this._proto._connect(r,s,i)}},{key:"attach",value:function(e,t,n,r,s,i,o){if(this._proto._attach)return this._proto._attach(e,t,n,r,s,i,o);var a=new Error('The "attach" method is not available for your connection protocol');throw a.name="StropheSessionError",a}},{key:"restore",value:function(e,t,n,r,s){if(!this._sessionCachingSupported()){var i=new Error('The "restore" method can only be used with a BOSH connection.');throw i.name="StropheSessionError",i}this._proto._restore(e,t,n,r,s)}},{key:"_sessionCachingSupported",value:function(){if(this._proto instanceof U.Bosh){if(!JSON)return!1;try{sessionStorage.setItem("_strophe_","_strophe_"),sessionStorage.removeItem("_strophe_")}catch(e){return!1}return!0}return!1}},{key:"xmlInput",value:function(e){}},{key:"xmlOutput",value:function(e){}},{key:"rawInput",value:function(e){}},{key:"rawOutput",value:function(e){}},{key:"nextValidRid",value:function(e){}},{key:"send",value:function(e){if(null!==e){if("function"===typeof e.sort)for(var t=0;t<e.length;t++)this._queueData(e[t]);else"function"===typeof e.tree?this._queueData(e.tree()):this._queueData(e);this._proto._send()}}},{key:"flush",value:function(){clearTimeout(this._idleTimeout),this._onIdle()}},{key:"sendPresence",value:function(e,t,n,r){var s=this,i=null;"function"===typeof e.tree&&(e=e.tree());var o=e.getAttribute("id");if(o||(o=this.getUniqueId("sendPresence"),e.setAttribute("id",o)),"function"===typeof t||"function"===typeof n){var a=this.addHandler((function(e){i&&s.deleteTimedHandler(i),"error"===e.getAttribute("type")?n&&n(e):t&&t(e)}),null,"presence",null,o);r&&(i=this.addTimedHandler(r,(function(){return s.deleteHandler(a),n&&n(null),!1})))}return this.send(e),o}},{key:"sendIQ",value:function(e,t,n,r){var s=this,i=null;"function"===typeof e.tree&&(e=e.tree());var o=e.getAttribute("id");if(o||(o=this.getUniqueId("sendIQ"),e.setAttribute("id",o)),"function"===typeof t||"function"===typeof n){var a=this.addHandler((function(e){i&&s.deleteTimedHandler(i);var r=e.getAttribute("type");if("result"===r)t&&t(e);else{if("error"!==r){var o=new Error("Got bad IQ type of ".concat(r));throw o.name="StropheError",o}n&&n(e)}}),null,"iq",["error","result"],o);r&&(i=this.addTimedHandler(r,(function(){return s.deleteHandler(a),n&&n(null),!1})))}return this.send(e),o}},{key:"_queueData",value:function(e){if(null===e||!e.tagName||!e.childNodes){var t=new Error("Cannot queue non-DOMElement.");throw t.name="StropheError",t}this._data.push(e)}},{key:"_sendRestart",value:function(){var e=this;this._data.push("restart"),this._proto._sendRestart(),this._idleTimeout=setTimeout((function(){return e._onIdle()}),100)}},{key:"addTimedHandler",value:function(e,t){var n=new U.TimedHandler(e,t);return this.addTimeds.push(n),n}},{key:"deleteTimedHandler",value:function(e){this.removeTimeds.push(e)}},{key:"addHandler",value:function(e,t,n,r,s,i,o){var a=new U.Handler(e,t,n,r,s,i,o);return this.addHandlers.push(a),a}},{key:"deleteHandler",value:function(e){this.removeHandlers.push(e);var t=this.addHandlers.indexOf(e);t>=0&&this.addHandlers.splice(t,1)}},{key:"registerSASLMechanisms",value:function(e){var t=this;this.mechanisms={},(e=e||[U.SASLAnonymous,U.SASLExternal,U.SASLOAuthBearer,U.SASLXOAuth2,U.SASLPlain,U.SASLSHA1]).forEach((function(e){return t.registerSASLMechanism(e)}))}},{key:"registerSASLMechanism",value:function(e){var t=new e;this.mechanisms[t.mechname]=t}},{key:"disconnect",value:function(e){if(this._changeConnectStatus(U.Status.DISCONNECTING,e),e?U.warn("Disconnect was called because: "+e):U.info("Disconnect was called"),this.connected){var t=!1;this.disconnecting=!0,this.authenticated&&(t=J({xmlns:U.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(3e3,this._onDisconnectTimeout.bind(this)),this._proto._disconnect(t)}else U.warn("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests(),this._doDisconnect()}},{key:"_changeConnectStatus",value:function(e,t,n){for(var r in U._connectionPlugins)if(Object.prototype.hasOwnProperty.call(U._connectionPlugins,r)){var s=this[r];if(s.statusChanged)try{s.statusChanged(e,t)}catch(i){U.error("".concat(r," plugin caused an exception changing status: ").concat(i))}}if(this.connect_callback)try{this.connect_callback(e,t,n)}catch(o){U._handleError(o),U.error("User connection callback caused an exception: ".concat(o))}}},{key:"_doDisconnect",value:function(e){"number"===typeof this._idleTimeout&&clearTimeout(this._idleTimeout),null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null),U.debug("_doDisconnect was called"),this._proto._doDisconnect(),this.authenticated=!1,this.disconnecting=!1,this.restored=!1,this.handlers=[],this.timedHandlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this._changeConnectStatus(U.Status.DISCONNECTED,e),this.connected=!1}},{key:"_dataRecv",value:function(e,t){var n=this,r=this._proto._reqToData(e);if(null!==r){for(this.xmlInput!==U.Connection.prototype.xmlInput&&(r.nodeName===this._proto.strip&&r.childNodes.length?this.xmlInput(r.childNodes[0]):this.xmlInput(r)),this.rawInput!==U.Connection.prototype.rawInput&&(t?this.rawInput(t):this.rawInput(U.serialize(r)));this.removeHandlers.length>0;){var s=this.removeHandlers.pop(),i=this.handlers.indexOf(s);i>=0&&this.handlers.splice(i,1)}for(;this.addHandlers.length>0;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue())this._doDisconnect();else{var o=r.getAttribute("type");if(null!==o&&"terminate"===o){if(this.disconnecting)return;var a=r.getAttribute("condition"),c=r.getElementsByTagName("conflict");return null!==a?("remote-stream-error"===a&&c.length>0&&(a="conflict"),this._changeConnectStatus(U.Status.CONNFAIL,a)):this._changeConnectStatus(U.Status.CONNFAIL,U.ErrorCondition.UNKOWN_REASON),void this._doDisconnect(a)}U.forEachChild(r,null,(function(e){var t=n.handlers;n.handlers=[];for(var r=0;r<t.length;r++){var s=t[r];try{(!s.isMatch(e)||!n.authenticated&&s.user||s.run(e))&&n.handlers.push(s)}catch(i){U.warn("Removing Strophe handlers due to uncaught exception: "+i.message)}}}))}}}},{key:"_connect_cb",value:function(e,t,n){var r,s=this;U.debug("_connect_cb was called"),this.connected=!0;try{r=this._proto._reqToData(e)}catch(o){if(o.name!==U.ErrorCondition.BAD_FORMAT)throw o;this._changeConnectStatus(U.Status.CONNFAIL,U.ErrorCondition.BAD_FORMAT),this._doDisconnect(U.ErrorCondition.BAD_FORMAT)}if(r&&(this.xmlInput!==U.Connection.prototype.xmlInput&&(r.nodeName===this._proto.strip&&r.childNodes.length?this.xmlInput(r.childNodes[0]):this.xmlInput(r)),this.rawInput!==U.Connection.prototype.rawInput&&(n?this.rawInput(n):this.rawInput(U.serialize(r))),this._proto._connect_cb(r)!==U.Status.CONNFAIL))if(r.getElementsByTagNameNS?r.getElementsByTagNameNS(U.NS.STREAM,"features").length>0:r.getElementsByTagName("stream:features").length>0||r.getElementsByTagName("features").length>0){var i=Array.from(r.getElementsByTagName("mechanism")).map((function(e){return s.mechanisms[e.textContent]})).filter((function(e){return e}));0!==i.length||0!==r.getElementsByTagName("auth").length?!1!==this.do_authentication&&this.authenticate(i):this._proto._no_auth_received(t)}else this._proto._no_auth_received(t)}},{key:"sortMechanismsByPriority",value:function(e){for(var t=0;t<e.length-1;++t){for(var n=t,r=t+1;r<e.length;++r)e[r].priority>e[n].priority&&(n=r);if(n!==t){var s=e[t];e[t]=e[n],e[n]=s}}return e}},{key:"authenticate",value:function(e){this._attemptSASLAuth(e)||this._attemptLegacyAuth()}},{key:"_attemptSASLAuth",value:function(e){e=this.sortMechanismsByPriority(e||[]);for(var t=!1,n=0;n<e.length;++n)if(e[n].test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null),this._sasl_mechanism=e[n],this._sasl_mechanism.onStart(this);var r=j("auth",{xmlns:U.NS.SASL,mechanism:this._sasl_mechanism.mechname});if(this._sasl_mechanism.isClientFirst){var s=this._sasl_mechanism.onChallenge(this,null);r.t(B.btoa(s))}this.send(r.tree()),t=!0;break}return t}},{key:"_sasl_challenge_cb",value:function(e){var t=B.atob(U.getText(e)),n=this._sasl_mechanism.onChallenge(this,t),r=j("response",{xmlns:U.NS.SASL});return""!==n&&r.t(B.btoa(n)),this.send(r.tree()),!0}},{key:"_attemptLegacyAuth",value:function(){null===U.getNodeFromJid(this.jid)?(this._changeConnectStatus(U.Status.CONNFAIL,U.ErrorCondition.MISSING_JID_NODE),this.disconnect(U.ErrorCondition.MISSING_JID_NODE)):(this._changeConnectStatus(U.Status.AUTHENTICATING,null),this._addSysHandler(this._onLegacyAuthIQResult.bind(this),null,null,null,"_auth_1"),this.send(X({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:U.NS.AUTH}).c("username",{}).t(U.getNodeFromJid(this.jid)).tree()))}},{key:"_onLegacyAuthIQResult",value:function(e){var t=X({type:"set",id:"_auth_2"}).c("query",{xmlns:U.NS.AUTH}).c("username",{}).t(U.getNodeFromJid(this.jid)).up().c("password").t(this.pass);return U.getResourceFromJid(this.jid)||(this.jid=U.getBareJidFromJid(this.jid)+"/strophe"),t.up().c("resource",{}).t(U.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2"),this.send(t.tree()),!1}},{key:"_sasl_success_cb",value:function(e){var t=this;if(this._sasl_data["server-signature"]){var n,r=B.atob(U.getText(e)).match(/([a-z]+)=([^,]+)(,|$)/);if("v"===r[1]&&(n=r[2]),n!==this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}U.info("SASL authentication succeeded."),this._sasl_mechanism&&this._sasl_mechanism.onSuccess(),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);var s=[],i=function(e,n){for(;e.length;)t.deleteHandler(e.pop());return t._onStreamFeaturesAfterSASL(n),!1};return s.push(this._addSysHandler((function(e){return i(s,e)}),null,"stream:features",null,null)),s.push(this._addSysHandler((function(e){return i(s,e)}),U.NS.STREAM,"features",null,null)),this._sendRestart(),!1}},{key:"_onStreamFeaturesAfterSASL",value:function(e){this.features=e;for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];"bind"===n.nodeName&&(this.do_bind=!0),"session"===n.nodeName&&(this.do_session=!0)}return this.do_bind?(this.options.explicitResourceBinding?this._changeConnectStatus(U.Status.BINDREQUIRED,null):this.bind(),!1):(this._changeConnectStatus(U.Status.AUTHFAIL,null),!1)}},{key:"bind",value:function(){if(this.do_bind){this._addSysHandler(this._onResourceBindResultIQ.bind(this),null,null,null,"_bind_auth_2");var e=U.getResourceFromJid(this.jid);e?this.send(X({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:U.NS.BIND}).c("resource",{}).t(e).tree()):this.send(X({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:U.NS.BIND}).tree())}else U.log(U.LogLevel.INFO,'Strophe.Connection.prototype.bind called but "do_bind" is false')}},{key:"_onResourceBindResultIQ",value:function(e){var t;if("error"===e.getAttribute("type"))return U.warn("Resource binding failed."),e.getElementsByTagName("conflict").length>0&&(t=U.ErrorCondition.CONFLICT),this._changeConnectStatus(U.Status.AUTHFAIL,t,e),!1;var n=e.getElementsByTagName("bind");if(!(n.length>0))return U.warn("Resource binding failed."),this._changeConnectStatus(U.Status.AUTHFAIL,null,e),!1;var r=n[0].getElementsByTagName("jid");r.length>0&&(this.authenticated=!0,this.jid=U.getText(r[0]),this.do_session?this._establishSession():this._changeConnectStatus(U.Status.CONNECTED,null))}},{key:"_establishSession",value:function(){if(!this.do_session)throw new Error("Strophe.Connection.prototype._establishSession "+"called but apparently ".concat(U.NS.SESSION," wasn't advertised by the server"));this._addSysHandler(this._onSessionResultIQ.bind(this),null,null,null,"_session_auth_2"),this.send(X({type:"set",id:"_session_auth_2"}).c("session",{xmlns:U.NS.SESSION}).tree())}},{key:"_onSessionResultIQ",value:function(e){if("result"===e.getAttribute("type"))this.authenticated=!0,this._changeConnectStatus(U.Status.CONNECTED,null);else if("error"===e.getAttribute("type"))return this.authenticated=!1,U.warn("Session creation failed."),this._changeConnectStatus(U.Status.AUTHFAIL,null,e),!1;return!1}},{key:"_sasl_failure_cb",value:function(e){return this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_mechanism&&this._sasl_mechanism.onFailure(),this._changeConnectStatus(U.Status.AUTHFAIL,null,e),!1}},{key:"_auth2_cb",value:function(e){return"result"===e.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(U.Status.CONNECTED,null)):"error"===e.getAttribute("type")&&(this._changeConnectStatus(U.Status.AUTHFAIL,null,e),this.disconnect("authentication failed")),!1}},{key:"_addSysTimedHandler",value:function(e,t){var n=new U.TimedHandler(e,t);return n.user=!1,this.addTimeds.push(n),n}},{key:"_addSysHandler",value:function(e,t,n,r,s){var i=new U.Handler(e,t,n,r,s);return i.user=!1,this.addHandlers.push(i),i}},{key:"_onDisconnectTimeout",value:function(){return U.debug("_onDisconnectTimeout was called"),this._changeConnectStatus(U.Status.CONNTIMEOUT,null),this._proto._onDisconnectTimeout(),this._doDisconnect(),!1}},{key:"_onIdle",value:function(){for(var e=this;this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());for(;this.removeTimeds.length>0;){var t=this.removeTimeds.pop(),n=this.timedHandlers.indexOf(t);n>=0&&this.timedHandlers.splice(n,1)}for(var r=(new Date).getTime(),s=[],i=0;i<this.timedHandlers.length;i++){var o=this.timedHandlers[i];!this.authenticated&&o.user||(o.lastCalled+o.period-r<=0?o.run()&&s.push(o):s.push(o))}this.timedHandlers=s,clearTimeout(this._idleTimeout),this._proto._onIdle(),this.connected&&(this._idleTimeout=setTimeout((function(){return e._onIdle()}),100))}}]),e}(),U.SASLMechanism=function(){function e(t,n,r){i(this,e),this.mechname=t,this.isClientFirst=n,this.priority=r}return a(e,[{key:"test",value:function(){return!0}},{key:"onStart",value:function(e){this._connection=e}},{key:"onChallenge",value:function(e,t){throw new Error("You should implement challenge handling!")}},{key:"onFailure",value:function(){this._connection=null}},{key:"onSuccess",value:function(){this._connection=null}}]),e}(),U.SASLAnonymous=function(e){c(n,e);var t=d(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"ANONYMOUS",r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;return i(this,n),t.call(this,e,r,s)}return a(n,[{key:"test",value:function(e){return null===e.authcid}}]),n}(U.SASLMechanism),U.SASLPlain=function(e){c(n,e);var t=d(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"PLAIN",r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50;return i(this,n),t.call(this,e,r,s)}return a(n,[{key:"test",value:function(e){return null!==e.authcid}},{key:"onChallenge",value:function(e){var t=e.authcid,n=e.authzid,r=e.domain,s=e.pass;if(!r)throw new Error("SASLPlain onChallenge: domain is not defined!");var i=n!=="".concat(t,"@").concat(r)?n:"";return i+="\0",i+=t,i+="\0",q(i+=s)}}]),n}(U.SASLMechanism),U.SASLSHA1=function(e){c(n,e);var t=d(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"SCRAM-SHA-1",r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:60;return i(this,n),t.call(this,e,r,s)}return a(n,[{key:"test",value:function(e){return null!==e.authcid}},{key:"onChallenge",value:function(e,t,n){var r=n||w.hexdigest(""+1234567890*Math.random()),s="n="+q(e.authcid);return s+=",r=",s+=r,e._sasl_data.cnonce=r,e._sasl_data["client-first-message-bare"]=s,s="n,,"+s,this.onChallenge=function(e,t){for(var n,r,s,i,o,a,c,u,h="c=biws,",l="".concat(e._sasl_data["client-first-message-bare"],",").concat(t,","),d=e._sasl_data.cnonce,_=/([a-z]+)=([^,]+)(,|$)/;t.match(_);){var f=t.match(_);switch(t=t.replace(f[0],""),f[1]){case"r":n=f[2];break;case"s":r=f[2];break;case"i":s=f[2]}}if(n.substr(0,d.length)!==d)return e._sasl_data={},e._sasl_failure_cb();l+=h+="r="+n,r=B.atob(r),r+="\0\0\0\x01";var m=q(e.pass);for(i=a=D.core_hmac_sha1(m,r),c=1;c<s;c++){for(o=D.core_hmac_sha1(m,D.binb2str(a)),u=0;u<5;u++)i[u]^=o[u];a=o}i=D.binb2str(i);var p=D.core_hmac_sha1(i,"Client Key"),g=D.str_hmac_sha1(i,"Server Key"),v=D.core_hmac_sha1(D.str_sha1(D.binb2str(p)),l);for(e._sasl_data["server-signature"]=D.b64_hmac_sha1(g,l),u=0;u<5;u++)p[u]^=v[u];return h+=",p="+B.btoa(D.binb2str(p))},s}}]),n}(U.SASLMechanism),U.SASLOAuthBearer=function(e){c(n,e);var t=d(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"OAUTHBEARER",r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:40;return i(this,n),t.call(this,e,r,s)}return a(n,[{key:"test",value:function(e){return null!==e.pass}},{key:"onChallenge",value:function(e){var t="n,";return null!==e.authcid&&(t=t+"a="+e.authzid),t+=",",t+="\x01",t+="auth=Bearer ",t+=e.pass,t+="\x01",q(t+="\x01")}}]),n}(U.SASLMechanism),U.SASLExternal=function(e){c(n,e);var t=d(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"EXTERNAL",r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;return i(this,n),t.call(this,e,r,s)}return a(n,[{key:"onChallenge",value:function(e){return e.authcid===e.authzid?"":e.authzid}}]),n}(U.SASLMechanism),U.SASLXOAuth2=function(e){c(n,e);var t=d(n);function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"X-OAUTH2",r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30;return i(this,n),t.call(this,e,r,s)}return a(n,[{key:"test",value:function(e){return null!==e.pass}},{key:"onChallenge",value:function(e){var t="\0";return null!==e.authcid&&(t+=e.authzid),t+="\0",t+=e.pass,q(t)}}]),n}(U.SASLMechanism);var W={Strophe:U,$build:j,$iq:X,$msg:P,$pres:J,SHA1:D,MD5:w,b64_hmac_sha1:D.b64_hmac_sha1,b64_sha1:D.b64_sha1,str_hmac_sha1:D.str_hmac_sha1,str_sha1:D.str_sha1};U.Request=function(){function e(t,n,r,s){i(this,e),this.id=++U._requestId,this.xmlData=t,this.data=U.serialize(t),this.origFunc=n,this.func=n,this.rid=r,this.date=NaN,this.sends=s||0,this.abort=!1,this.dead=null,this.age=function(){return this.date?(new Date-this.date)/1e3:0},this.timeDead=function(){return this.dead?(new Date-this.dead)/1e3:0},this.xhr=this._newXHR()}return a(e,[{key:"getResponse",value:function(){var e=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if("parsererror"===(e=this.xhr.responseXML.documentElement).tagName)throw U.error("invalid response received"),U.error("responseText: "+this.xhr.responseText),U.error("responseXML: "+U.serialize(this.xhr.responseXML)),new Error("parsererror")}else if(this.xhr.responseText){if(U.debug("Got responseText but no responseXML; attempting to parse it with DOMParser..."),!(e=(new p).parseFromString(this.xhr.responseText,"application/xml").documentElement))throw new Error("Parsing produced null node");if(e.querySelector("parsererror")){U.error("invalid response received: "+e.querySelector("parsererror").textContent),U.error("responseText: "+this.xhr.responseText);var t=new Error;throw t.name=U.ErrorCondition.BAD_FORMAT,t}}return e}},{key:"_newXHR",value:function(){var e=null;return window.XMLHttpRequest?(e=new XMLHttpRequest).overrideMimeType&&e.overrideMimeType("text/xml; charset=utf-8"):window.ActiveXObject&&(e=new ActiveXObject("Microsoft.XMLHTTP")),e.onreadystatechange=this.func.bind(null,this),e}}]),e}(),U.Bosh=function(){function e(t){i(this,e),this._conn=t,this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.hold=1,this.wait=60,this.window=5,this.errors=0,this.inactivity=null,this.lastResponseHeaders=null,this._requests=[]}return a(e,[{key:"_buildBody",value:function(){var e=j("body",{rid:this.rid++,xmlns:U.NS.HTTPBIND});return null!==this.sid&&e.attrs({sid:this.sid}),this._conn.options.keepalive&&this._conn._sessionCachingSupported()&&this._cacheSession(),e}},{key:"_reset",value:function(){this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.errors=0,this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session"),this._conn.nextValidRid(this.rid)}},{key:"_connect",value:function(e,t,n){this.wait=e||this.wait,this.hold=t||this.hold,this.errors=0;var r=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":U.NS.BOSH});n&&r.attrs({route:n});var s=this._conn._connect_cb;this._requests.push(new U.Request(r.tree(),this._onRequestStateChange.bind(this,s.bind(this._conn)),r.tree().getAttribute("rid"))),this._throttledRequestHandler()}},{key:"_attach",value:function(e,t,n,r,s,i,o){this._conn.jid=e,this.sid=t,this.rid=n,this._conn.connect_callback=r,this._conn.domain=U.getDomainFromJid(this._conn.jid),this._conn.authenticated=!0,this._conn.connected=!0,this.wait=s||this.wait,this.hold=i||this.hold,this.window=o||this.window,this._conn._changeConnectStatus(U.Status.ATTACHED,null)}},{key:"_restore",value:function(e,t,n,r,s){var i=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(!("undefined"!==typeof i&&null!==i&&i.rid&&i.sid&&i.jid&&("undefined"===typeof e||null===e||U.getBareJidFromJid(i.jid)===U.getBareJidFromJid(e)||null===U.getNodeFromJid(e)&&U.getDomainFromJid(i.jid)===e))){var o=new Error("_restore: no restoreable session.");throw o.name="StropheSessionError",o}this._conn.restored=!0,this._attach(i.jid,i.sid,i.rid,t,n,r,s)}},{key:"_cacheSession",value:function(){this._conn.authenticated?this._conn.jid&&this.rid&&this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid})):window.sessionStorage.removeItem("strophe-bosh-session")}},{key:"_connect_cb",value:function(e){var t=e.getAttribute("type");if(null!==t&&"terminate"===t){var n=e.getAttribute("condition");U.error("BOSH-Connection failed: "+n);var r=e.getElementsByTagName("conflict");return null!==n?("remote-stream-error"===n&&r.length>0&&(n="conflict"),this._conn._changeConnectStatus(U.Status.CONNFAIL,n)):this._conn._changeConnectStatus(U.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(n),U.Status.CONNFAIL}this.sid||(this.sid=e.getAttribute("sid"));var s=e.getAttribute("requests");s&&(this.window=parseInt(s,10));var i=e.getAttribute("hold");i&&(this.hold=parseInt(i,10));var o=e.getAttribute("wait");o&&(this.wait=parseInt(o,10));var a=e.getAttribute("inactivity");a&&(this.inactivity=parseInt(a,10))}},{key:"_disconnect",value:function(e){this._sendTerminate(e)}},{key:"_doDisconnect",value:function(){this.sid=null,this.rid=Math.floor(4294967295*Math.random()),this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session"),this._conn.nextValidRid(this.rid)}},{key:"_emptyQueue",value:function(){return 0===this._requests.length}},{key:"_callProtocolErrorHandlers",value:function(t){var n=e._getRequestStatus(t),r=this._conn.protocolErrorHandlers.HTTP[n];r&&r.call(this,n)}},{key:"_hitError",value:function(e){this.errors++,U.warn("request errored, status: "+e+", number of errors: "+this.errors),this.errors>4&&this._conn._onDisconnectTimeout()}},{key:"_no_auth_received",value:function(e){U.warn("Server did not yet offer a supported authentication mechanism. Sending a blank poll request."),e=e?e.bind(this._conn):this._conn._connect_cb.bind(this._conn);var t=this._buildBody();this._requests.push(new U.Request(t.tree(),this._onRequestStateChange.bind(this,e),t.tree().getAttribute("rid"))),this._throttledRequestHandler()}},{key:"_onDisconnectTimeout",value:function(){this._abortAllRequests()}},{key:"_abortAllRequests",value:function(){for(;this._requests.length>0;){var e=this._requests.pop();e.abort=!0,e.xhr.abort(),e.xhr.onreadystatechange=function(){}}}},{key:"_onIdle",value:function(){var e=this._conn._data;if(this._conn.authenticated&&0===this._requests.length&&0===e.length&&!this._conn.disconnecting&&(U.debug("no requests during idle cycle, sending blank request"),e.push(null)),!this._conn.paused){if(this._requests.length<2&&e.length>0){for(var t=this._buildBody(),n=0;n<e.length;n++)null!==e[n]&&("restart"===e[n]?t.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":U.NS.BOSH}):t.cnode(e[n]).up());delete this._conn._data,this._conn._data=[],this._requests.push(new U.Request(t.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),t.tree().getAttribute("rid"))),this._throttledRequestHandler()}if(this._requests.length>0){var r=this._requests[0].age();null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(U.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),r>Math.floor(U.TIMEOUT*this.wait)&&(U.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(U.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler())}}}},{key:"_onRequestStateChange",value:function(t,n){if(U.debug("request id "+n.id+"."+n.sends+" state changed to "+n.xhr.readyState),n.abort)n.abort=!1;else if(4===n.xhr.readyState){var r=e._getRequestStatus(n);if(this.lastResponseHeaders=n.xhr.getAllResponseHeaders(),this._conn.disconnecting&&r>=400)return this._hitError(r),void this._callProtocolErrorHandlers(n);var s=r>0&&r<500,i=n.sends>this._conn.maxRetries;if((s||i)&&(this._removeRequest(n),U.debug("request id "+n.id+" should now be removed")),200===r){var o=this._requests[0]===n;(this._requests[1]===n||o&&this._requests.length>0&&this._requests[0].age()>Math.floor(U.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),this._conn.nextValidRid(Number(n.rid)+1),U.debug("request id "+n.id+"."+n.sends+" got 200"),t(n),this.errors=0}else 0===r||r>=400&&r<600||r>=12e3?(U.error("request id "+n.id+"."+n.sends+" error "+r+" happened"),this._hitError(r),this._callProtocolErrorHandlers(n),r>=400&&r<500&&(this._conn._changeConnectStatus(U.Status.DISCONNECTING,null),this._conn._doDisconnect())):U.error("request id "+n.id+"."+n.sends+" error "+r+" happened");s||i?i&&!this._conn.connected&&this._conn._changeConnectStatus(U.Status.CONNFAIL,"giving-up"):this._throttledRequestHandler()}}},{key:"_processRequest",value:function(t){var n=this,r=this._requests[t],s=e._getRequestStatus(r,-1);if(r.sends>this._conn.maxRetries)this._conn._onDisconnectTimeout();else{var i=r.age(),o=!isNaN(i)&&i>Math.floor(U.TIMEOUT*this.wait),a=null!==r.dead&&r.timeDead()>Math.floor(U.SECONDARY_TIMEOUT*this.wait),c=4===r.xhr.readyState&&(s<1||s>=500);if((o||a||c)&&(a&&U.error("Request ".concat(this._requests[t].id," timed out (secondary), restarting")),r.abort=!0,r.xhr.abort(),r.xhr.onreadystatechange=function(){},this._requests[t]=new U.Request(r.xmlData,r.origFunc,r.rid,r.sends),r=this._requests[t]),0===r.xhr.readyState){U.debug("request id "+r.id+"."+r.sends+" posting");try{var u=this._conn.options.contentType||"text/xml; charset=utf-8";r.xhr.open("POST",this._conn.service,!this._conn.options.sync),"undefined"!==typeof r.xhr.setRequestHeader&&r.xhr.setRequestHeader("Content-Type",u),this._conn.options.withCredentials&&(r.xhr.withCredentials=!0)}catch(d){return U.error("XHR open failed: "+d.toString()),this._conn.connected||this._conn._changeConnectStatus(U.Status.CONNFAIL,"bad-service"),void this._conn.disconnect()}var h=function(){if(r.date=new Date,n._conn.options.customHeaders){var e=n._conn.options.customHeaders;for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&r.xhr.setRequestHeader(t,e[t])}r.xhr.send(r.data)};if(r.sends>1){var l=1e3*Math.min(Math.floor(U.TIMEOUT*this.wait),Math.pow(r.sends,3));setTimeout((function(){h()}),l)}else h();r.sends++,this._conn.xmlOutput!==U.Connection.prototype.xmlOutput&&(r.xmlData.nodeName===this.strip&&r.xmlData.childNodes.length?this._conn.xmlOutput(r.xmlData.childNodes[0]):this._conn.xmlOutput(r.xmlData)),this._conn.rawOutput!==U.Connection.prototype.rawOutput&&this._conn.rawOutput(r.data)}else U.debug("_processRequest: "+(0===t?"first":"second")+" request has readyState of "+r.xhr.readyState)}}},{key:"_removeRequest",value:function(e){U.debug("removing request");for(var t=this._requests.length-1;t>=0;t--)e===this._requests[t]&&this._requests.splice(t,1);e.xhr.onreadystatechange=function(){},this._throttledRequestHandler()}},{key:"_restartRequest",value:function(e){var t=this._requests[e];null===t.dead&&(t.dead=new Date),this._processRequest(e)}},{key:"_reqToData",value:function(e){try{return e.getResponse()}catch(t){if("parsererror"!==t.message)throw t;this._conn.disconnect("strophe-parsererror")}}},{key:"_sendTerminate",value:function(e){U.debug("_sendTerminate was called");var t=this._buildBody().attrs({type:"terminate"});e&&t.cnode(e.tree());var n=new U.Request(t.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),t.tree().getAttribute("rid"));this._requests.push(n),this._throttledRequestHandler()}},{key:"_send",value:function(){var e=this;clearTimeout(this._conn._idleTimeout),this._throttledRequestHandler(),this._conn._idleTimeout=setTimeout((function(){return e._conn._onIdle()}),100)}},{key:"_sendRestart",value:function(){this._throttledRequestHandler(),clearTimeout(this._conn._idleTimeout)}},{key:"_throttledRequestHandler",value:function(){this._requests?U.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):U.debug("_throttledRequestHandler called with undefined requests"),this._requests&&0!==this._requests.length&&(this._requests.length>0&&this._processRequest(0),this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}}],[{key:"_getRequestStatus",value:function(e,t){var n;if(4===e.xhr.readyState)try{n=e.xhr.status}catch(r){U.error("Caught an error while retrieving a request's status, reqStatus: "+n)}return"undefined"===typeof n&&(n="number"===typeof t?t:0),n}}]),e}(),U.Bosh.prototype.strip=null,U.Websocket=function(){function e(t){i(this,e),this._conn=t,this.strip="wrapper";var n=t.service;if(0!==n.indexOf("ws:")&&0!==n.indexOf("wss:")){var r="";"ws"===t.options.protocol&&"https:"!==window.location.protocol?r+="ws":r+="wss",r+="://"+window.location.host,0!==n.indexOf("/")?r+=window.location.pathname+n:r+=n,t.service=r}}return a(e,[{key:"_buildStream",value:function(){return j("open",{xmlns:U.NS.FRAMING,to:this._conn.domain,version:"1.0"})}},{key:"_checkStreamError",value:function(e,t){var n;if(0===(n=e.getElementsByTagNameNS?e.getElementsByTagNameNS(U.NS.STREAM,"error"):e.getElementsByTagName("stream:error")).length)return!1;for(var r=n[0],s="",i="",o=0;o<r.childNodes.length;o++){var a=r.childNodes[o];if("urn:ietf:params:xml:ns:xmpp-streams"!==a.getAttribute("xmlns"))break;"text"===a.nodeName?i=a.textContent:s=a.nodeName}var c="WebSocket stream error: ";return c+=s||"unknown",i&&(c+=" - "+i),U.error(c),this._conn._changeConnectStatus(t,s),this._conn._doDisconnect(),!0}},{key:"_reset",value:function(){}},{key:"_connect",value:function(){var e=this;this._closeSocket(),this.socket=new m(this._conn.service,"xmpp"),this.socket.onopen=function(){return e._onOpen()},this.socket.onerror=function(t){return e._onError(t)},this.socket.onclose=function(t){return e._onClose(t)},this.socket.onmessage=function(t){return e._onInitialMessage(t)}}},{key:"_connect_cb",value:function(e){if(this._checkStreamError(e,U.Status.CONNFAIL))return U.Status.CONNFAIL}},{key:"_handleStreamStart",value:function(e){var t=!1,n=e.getAttribute("xmlns");"string"!==typeof n?t="Missing xmlns in <open />":n!==U.NS.FRAMING&&(t="Wrong xmlns in <open />: "+n);var r=e.getAttribute("version");return"string"!==typeof r?t="Missing version in <open />":"1.0"!==r&&(t="Wrong version in <open />: "+r),!t||(this._conn._changeConnectStatus(U.Status.CONNFAIL,t),this._conn._doDisconnect(),!1)}},{key:"_onInitialMessage",value:function(e){if(0===e.data.indexOf("<open ")||0===e.data.indexOf("<?xml")){var t=e.data.replace(/^(<\?.*?\?>\s*)*/,"");if(""===t)return;var n=(new p).parseFromString(t,"text/xml").documentElement;this._conn.xmlInput(n),this._conn.rawInput(e.data),this._handleStreamStart(n)&&this._connect_cb(n)}else if(0===e.data.indexOf("<close ")){var r=(new p).parseFromString(e.data,"text/xml").documentElement;this._conn.xmlInput(r),this._conn.rawInput(e.data);var s=r.getAttribute("see-other-uri");if(s){var i=this._conn.service;(i.indexOf("wss:")>=0&&s.indexOf("wss:")>=0||i.indexOf("ws:")>=0)&&(this._conn._changeConnectStatus(U.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=s,this._connect())}else this._conn._changeConnectStatus(U.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect()}else{this._replaceMessageHandler();var o=this._streamWrap(e.data),a=(new p).parseFromString(o,"text/xml").documentElement;this._conn._connect_cb(a,null,e.data)}}},{key:"_replaceMessageHandler",value:function(){var e=this;this.socket.onmessage=function(t){return e._onMessage(t)}}},{key:"_disconnect",value:function(e){var t=this;if(this.socket&&this.socket.readyState!==m.CLOSED){e&&this._conn.send(e);var n=j("close",{xmlns:U.NS.FRAMING});this._conn.xmlOutput(n.tree());var r=U.serialize(n);this._conn.rawOutput(r);try{this.socket.send(r)}catch(s){U.warn("Couldn't send <close /> tag.")}}setTimeout((function(){return t._conn._doDisconnect}),0)}},{key:"_doDisconnect",value:function(){U.debug("WebSockets _doDisconnect was called"),this._closeSocket()}},{key:"_streamWrap",value:function(e){return"<wrapper>"+e+"</wrapper>"}},{key:"_closeSocket",value:function(){if(this.socket)try{this.socket.onclose=null,this.socket.onerror=null,this.socket.onmessage=null,this.socket.close()}catch(e){U.debug(e.message)}this.socket=null}},{key:"_emptyQueue",value:function(){return!0}},{key:"_onClose",value:function(e){this._conn.connected&&!this._conn.disconnecting?(U.error("Websocket closed unexpectedly"),this._conn._doDisconnect()):e&&1006===e.code&&!this._conn.connected&&this.socket?(U.error("Websocket closed unexcectedly"),this._conn._changeConnectStatus(U.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),this._conn._doDisconnect()):U.debug("Websocket closed")}},{key:"_no_auth_received",value:function(e){U.error("Server did not offer a supported authentication mechanism"),this._conn._changeConnectStatus(U.Status.CONNFAIL,U.ErrorCondition.NO_AUTH_MECH),e&&e.call(this._conn),this._conn._doDisconnect()}},{key:"_onDisconnectTimeout",value:function(){}},{key:"_abortAllRequests",value:function(){}},{key:"_onError",value:function(e){U.error("Websocket error "+e),this._conn._changeConnectStatus(U.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),this._disconnect()}},{key:"_onIdle",value:function(){var e=this._conn._data;if(e.length>0&&!this._conn.paused){for(var t=0;t<e.length;t++)if(null!==e[t]){var n=void 0;n="restart"===e[t]?this._buildStream().tree():e[t];var r=U.serialize(n);this._conn.xmlOutput(n),this._conn.rawOutput(r),this.socket.send(r)}this._conn._data=[]}}},{key:"_onMessage",value:function(e){var t,n='<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />';if(e.data===n)return this._conn.rawInput(n),this._conn.xmlInput(e),void(this._conn.disconnecting||this._conn._doDisconnect());if(0===e.data.search("<open ")){if(t=(new p).parseFromString(e.data,"text/xml").documentElement,!this._handleStreamStart(t))return}else{var r=this._streamWrap(e.data);t=(new p).parseFromString(r,"text/xml").documentElement}return this._checkStreamError(t,U.Status.ERROR)?void 0:this._conn.disconnecting&&"presence"===t.firstChild.nodeName&&"unavailable"===t.firstChild.getAttribute("type")?(this._conn.xmlInput(t),void this._conn.rawInput(U.serialize(t))):void this._conn._dataRecv(t,e.data)}},{key:"_onOpen",value:function(){U.debug("Websocket open");var e=this._buildStream();this._conn.xmlOutput(e.tree());var t=U.serialize(e);this._conn.rawOutput(t),this.socket.send(t)}},{key:"_reqToData",value:function(e){return e}},{key:"_send",value:function(){this._conn.flush()}},{key:"_sendRestart",value:function(){clearTimeout(this._conn._idleTimeout),this._conn._onIdle.bind(this._conn)()}}]),e}();var G={};G.debug=U.LogLevel.DEBUG,G.info=U.LogLevel.INFO,G.warn=U.LogLevel.WARN,G.error=U.LogLevel.ERROR,G.fatal=U.LogLevel.FATAL,U.WorkerWebsocket=function(e){c(n,e);var t=d(n);function n(e){var r;return i(this,n),(r=t.call(this,e))._conn=e,r.worker=new SharedWorker(r._conn.options.worker,"Strophe XMPP Connection"),r.worker.onerror=function(e){var t;null===(t=console)||void 0===t||t.error(e),U.log(U.LogLevel.ERROR,"Shared Worker Error: ".concat(e))},r}return a(n,[{key:"_connect",value:function(){var e=this;this._messageHandler=function(t){return e._onInitialMessage(t)},this.worker.port.start(),this.worker.port.onmessage=function(t){return e._onWorkerMessage(t)},this.worker.port.postMessage(["_connect",this._conn.service,this._conn.jid])}},{key:"_attach",value:function(e){var t=this;this._messageHandler=function(e){return t._onMessage(e)},this._conn.connect_callback=e,this.worker.port.start(),this.worker.port.onmessage=function(e){return t._onWorkerMessage(e)},this.worker.port.postMessage(["_attach",this._conn.service])}},{key:"_attachCallback",value:function(e,t){e===U.Status.ATTACHED?(this._conn.jid=t,this._conn.authenticated=!0,this._conn.connected=!0,this._conn.restored=!0,this._conn._changeConnectStatus(U.Status.ATTACHED)):e===U.Status.ATTACHFAIL&&(this._conn.authenticated=!1,this._conn.connected=!1,this._conn.restored=!1,this._conn._changeConnectStatus(U.Status.ATTACHFAIL))}},{key:"_disconnect",value:function(e,t){t&&this._conn.send(t);var n=j("close",{xmlns:U.NS.FRAMING});this._conn.xmlOutput(n.tree());var r=U.serialize(n);this._conn.rawOutput(r),this.worker.port.postMessage(["send",r]),this._conn._doDisconnect()}},{key:"_onClose",value:function(e){this._conn.connected&&!this._conn.disconnecting?(U.error("Websocket closed unexpectedly"),this._conn._doDisconnect()):e&&1006===e.code&&!this._conn.connected?(U.error("Websocket closed unexcectedly"),this._conn._changeConnectStatus(U.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),this._conn._doDisconnect()):U.debug("Websocket closed")}},{key:"_closeSocket",value:function(){this.worker.port.postMessage(["_closeSocket"])}},{key:"_replaceMessageHandler",value:function(){var e=this;this._messageHandler=function(t){return e._onMessage(t)}}},{key:"_onWorkerMessage",value:function(e){var t=e.data,n=t[0];if("_onMessage"===n)this._messageHandler(t[1]);else if(n in this)try{this[n].apply(this,e.data.slice(1))}catch(i){U.log(U.LogLevel.ERROR,i)}else if("log"===n){var r=t[1],s=t[2];U.log(G[r],s)}else U.log(U.LogLevel.ERROR,"Found unhandled service worker message: ".concat(t))}},{key:"socket",get:function(){var e=this;return{send:function(t){return e.worker.port.postMessage(["send",t])}}}}]),n}(U.Websocket),r.$build=W.$build,r.$iq=W.$iq,r.$msg=W.$msg,r.$pres=W.$pres,r.Strophe=W.Strophe;var z=D.b64_sha1;t.$build=j,t.$iq=X,t.$msg=P,t.$pres=J,t.Strophe=U,t.b64_sha1=z,Object.defineProperty(t,"__esModule",{value:!0})})(t)}).call(this,n("ntbh"))}}]);